pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
-- it slug
-- brettski

function _init()
 debug={}
 t=0
 initanidata()
 --left,right,up,down;0-3
 dirx={-1,1,0,0}
 diry={0,0,-1,1}
 
 _upd=updategame
 _drw=drawgame
 startgame()
end

function _update()
 t+=1
 _upd()
end

function _draw()
 _drw()
 drawdebug()
end

function startgame()
 buttonbuf=-1
 movefn=nil
 actdrawfn=nil
 plr_x=3
 plr_y=3
 plr_ox=0
 plr_oy=0
 plr_sox=0
 plr_soy=0
 plr_flp=false
 plr_mov=nil
 plr_t=0
 cur_x=1
 cur_y=14
 
 loadlevel(0)
end

function loadlevel(_lvl)
 --will handle items like setting
 --default camera for this level
 --etc.

	--gets sprites to animate desks
--	function getdeskani()
	 for x=0,127 do
	  for y=0,63 do
	   local spt=mget(x,y)
	   if fget(spt,2) then
	    local da={spt,spt-16,spt-32}
	    add(deskani,da)
	    add(deskanix,x*8)
	    add(deskaniy,y*8)
	    mset(x,y,61)
	   end
	  end
	 end
	--end
end
-->8
--updates

function updategame()
 --dobutton(getbutton())
 movefn=moveplayer
 actdrawfn=drawplr
 dobuttonbuf()
 dobutton(buttonbuf)
 buttonbuf=-1
end

function dobuttonbuf()
 if buttonbuf==-1 then
  buttonbuf=getbutton()
 end
end

function getbutton()
	for i=0,5 do
	 if btnp(i) then
	  return i
	 end
	end
	return -1
end

function dobutton(butt)
 if butt<0 then return end
 if butt<4 then
  movefn(dirx[butt+1],diry[butt+1])
  --plr_x+=dirx[butt+1]
  --plr_y+=diry[butt+1]
 elseif butt==4 then -- ðŸ…¾ï¸
  switch_mode()
 --menu buttons here ðŸ…¾ï¸âŽ
 --ðŸ…¾ï¸ switch modes
 --âŽ select
 end
end

function update_plrturn()
 dobuttonbuf()
 plr_t=min(plr_t+0.125,1)

 plr_mov()
 if plr_t==1 then
  _upd=updategame
 end
end

function movwalk()
 plr_ox=plr_sox*(1-plr_t)
 plr_oy=plr_soy*(1-plr_t)
end

--cursor mode
function update_cursor()
 local bn=getbutton()
 if bn==4 then
  _upd=updategame
  return
 elseif bn>=0 and bn<4 then
  movefn=movecursor
  dobutton(bn)
 end
end
-->8
--drawing

function drawgame()
 cls(0)
 map()
 drawspr(waterc,14*8,4*8,28,false)
 dodeskani()
 --drawspr(plr_ani,plr_x*8+plr_ox,plr_y*8+plr_oy,dfltani_spd,plr_flp)
 actdrawfn()
end

function drawplr()
  drawspr(plr_ani,plr_x*8+plr_ox,plr_y*8+plr_oy,dfltani_spd,plr_flp) 
end

function drawcursor()
 drawspr(cur_ani,cur_x*8,cur_y*8,dfltani_spd,false,true)
end

function getframe(ani,spd)
 return ani[flr(t/spd)%#ani+1]
end

function dodeskani()
 for i=1,#deskani do
  drawspr(deskani[i],
   deskanix[i],
   deskaniy[i],
   dfltani_spd,
   false)
 end
end

function drawspr(_sprts,_x,_y,spd,flp,trnsp)
 trnsp=trnsp or false
 palt(0,trnsp)
 spr(getframe(_sprts,spd),_x,_y,1,1,flp)
 pal()
end

function drawdebug()
 cursor(1,109)
 color(8)
 for txt in all(debug) do
  print(txt)
 end
end
-->8
--utils


-->8
--data

-- init animation data
function initanidata()
 dfltani_spd=10
 plr_ani={16,17,18,19}
 cur_ani={20,21}
 waterc={49,50,51,52}
 deskani={}
 deskanix={}
 deskaniy={}
end
-->8
--gameplay

function moveplayer(_dx,_dy)
 local destx,desty=
  plr_x+_dx,plr_y+_dy
 local tile=mget(destx,desty)
 
 if _dx<0 then 
 	plr_flp=true 
 elseif _dx>0 then
 --keep same if 0
  plr_flp=false
 end
 
 --todo check for desk first
 if fget(tile,0) then --solid
  return
  --todo add bump
 else --ok to walk
  plr_x+=_dx
  plr_y+=_dy
  plr_sox,plr_soy=-_dx*8,-_dy*8
  plr_ox,plr_oy=plr_sox,plr_soy
  plr_t=0
  _upd=update_plrturn
  plr_mov=movwalk
 end
end

--switch from player mode to 
--cursor mode (or back)
function switch_mode()
 debug={}
 _upd=update_cursor
 actdrawfn=drawcursor
end

function movecursor(_dx,_dy)
 cur_x+=_dx
 cur_y+=_dy
end
__gfx__
00000000000000000000000000000000000000000000000004444400004444400000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000004aaa400004ffff00000000000000000000000000000000000000000000000000000000000000000
007007000000000000000000000000000000000000000000043f3400004fc9c00000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000fff00000ff44400000000000000000000000000000000000000000000000000000000000000000
0007700000000000000000000000000000000000000000000ccfcc00004ffff00000000000000000000000000000000000000000000000000000000000000000
0070070000000000000000000000000000000000000000000fcccf00033ee8e00000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000001010000f33333f0000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000101000001101100000000000000000000000000000000000000000000000000000000000000000
00000000099999900000000009999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
09999990099999900999999009999990077777700666666000000000000000000000000000000000000000000000000000000000000000000000000000000000
0999999009f3f3000999999009f3f300070000700600006000000000000000000000000000000000000000000000000000000000000000000000000000000000
09f3f30000ffff0009f3f30000ffff00070000700600006000000000000000000000000000000000000000000000000000000000000000000000000000000000
00ffff0000ffff0000ffff0000ffff00070000700600006000000000000000000000000000000000000000000000000000000000000000000000000000000000
41156140411561000115610001156140070000700600006000000000000000000000000000000000000000000000000000000000000000000000000000000000
02255200022552100225520012255200077777700666666000000000000000000000000000000000000000000000000000000000000000000000000000000000
01000100010000000010010000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005555550
0056665000cccc0000cccc0000cccc0000cccc000000000000000000000000000000000000000000000000000000000000000000000000000000050050000005
005555500cc66cc00cc66cc00cc66cc00cc66cc00000000000000000000000000000000000000000000000000000000000000000000000000000500050000005
556667500c6666c00c6666c00c6666c00c6666c00000000000000000000000000000000000000000000000000000000000000000000000000000000050051005
056177500c6cccc00cccc6c00cc6ccc00cc6ccc00000000000000000000000000000000000000000000000000000000000000000000000000500000050015005
056115500cccc6c00ccdccc00cccccc00cccc6c00000000000000000000000000000000000000000000000000000000000000000000000000050000050000005
056115500cc6ccc00cccccc00c6c6cc00c6cdcc00000000000000000000000000000000000000000000000000000000000000000050000000000000050000005
055555500cccccc00c6c6cc00cccc6c00cccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000005555550
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000001111100000000000444440000000000aaaaa00000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000019991000000000004fff4000000000000fff000000000000afffa000000
000000000000000000000000000000000000000000000000000000000000000000000139310000000000446f640000000000001f1000000000000acfca000000
00000000000000000000000000000000000000000000000000000000000000000000119991100000000004fff4000000000000fff00000000000aafffaa00000
000000000000000000000000000000000000000000000000000000000000000000010229221000000000099f9900000000000ccfcc0000000000a22f22a00000
0000000000000000000000000000000000000000000000000000000000000000000002e2e2000000000009eee900000000000fcccf0000000000af222f000000
0000000000000000000000000000000000000000000000000000000000000000994445444544444099444444444444409944f44444444440994444f4f4444440
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000011111000000000044444000000000000aaaaa000000000000aaa0000000
0000000000000000000000000000000000000000000000000000000000000000000001999100000000004fff4000000000000afff000000000000afffa000000
00000000000000000000000000000000000000000000000000000000000000000000013931000000000046f6400000000000001f1000000000000acfca000000
0000000000000000000000000000000000000000000000000000000000000000000011999110000000004fff44000000000000fff00000000000aafffaa00000
00000000000000000000000000000000000000000000000000000000000000000000122922010000000009f99900000000000ccfcc0000000000a22f22a00000
0000000000000000000000000000000000000000000000000000000000000000000002e2e2000000000009eee900000000000fcccf0000000000af222f000000
0000000000000000000000000000000000000000000000000000000000000000994444d4d444444099444f444444444099444f444444444099444f444f444440
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000011111000000000004444400000000000aaaa0000000000000aaa0000000
00000000000000000000000000000000000000000000000000000000000000000000019991000000000004fff4000000000000fffa00000000000afffa000000
000000000000000000000000000000000000000000000000000000000000000000000139310000000000046f640000000000001f1000000000000acfca000000
00000000000000000000000000000000000000000000000000000000000000000000119991100000000044fff4000000000000fff00000000000aafffaa00000
000000000000000000000000000000000000000000000000000000000000000000001229221000000000099f9900000000000ccfcc0000000000a22f22a00000
0000000000000000000000000000000000000000000000000000000000000000000002e2e2000000000009eee900000000000fcccf0000000000af222f0a0000
0000000000000000000000000000000000000000000000000000000000000000994445444544444099444f444f44444099444f444f44444099444f444f444440
00000000000000000000000000000000000000000000000000000000000000009444111111d444409444111111d444409444666666d444409444666666d44440
00000000000000000000000000000000000000000000000000000000000000009444111111144440944411111114444094446666666444409444666666644440
00000000000000000000000000000000000000000000000000000000000000004444111711d444404444111711d444404444666566d444404444666566d44440
00000000000000000000000000000000000000000000000000000000000000004444d11111d444404444d11111d444404444d66666d444404444d66666d44440
00000000000000000000000000000000000000000000000000000000000000000944444444444400044000000000440004000000000004000400000000000400
00000000000000000000000000000000000000000000000000000000000000000940000000004400044000000000440004000000000004000400000000000400
00000000000000000000000000000000000000000000000000000000000000000440000000009400044000000000440004000000000004000400000000000400
00000000000000000000000000000000000000000000000000000000000000000440000000009400044000000000940004000000000004000400000000000400
00000000000000000000000011111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000011111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000011111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000011111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000011111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000654444444440000000066666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000554444444940000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000444494444440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000444000000000444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000944000000000949000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000444000000000449000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000949000000000444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000444000000000444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000449000000000944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000444000000000444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000944444900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000444444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000444494400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101010101000000000000000003000100000000000000000303030307070707000000000000000003030303070707070000000000000000070707070707070701010101000000000303030303030303
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
8081813f3f3f3f3f3f3f3f3f3f3f3f3f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
908383833e3e3e3e000000000000003f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
903e3e3e3e68693e006c6d000000003f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
903e3e3e3e78793e007c7d000000003f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
903e3e3e3e3e3e3e000000000000313f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
903e3e3e3e6a6b3e006e6f000000303f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
903e3e3e3e7a7b3e007e7f000000003f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
903e3e3e3e3e3e3e000000000000003f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3f3e3e3e3e3e003e000000000000003f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3f00000000000000000000000000003f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3f00000000000000000000000000003f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3f00000000000000000000000000003f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3f00000000000000000000000000003f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3f3f3f3f3f3f3f3f3f3f3f3f3f3f3f3f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3f00000000000000000000000000003f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3f3f3f3f3f3f3f3f3f3f3f3f3f3f3f3f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
