pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
--mines
--brettski

function _init()
 t=0
 
 
 maxgamex=14
 maxgamey=14
 xfield=10   --field x max
 yfield=10   --field y max
 bombcount=10
 bombs={} --bomb locations
 field={}    --playing field

 loaddata()
 loadanisets()
 gamestart()
 _upd=updategame
 _drw=drawgame
end

function _update()
 t+=1
 
 --_upd
end

function _draw()

	_drw()
end


-->8
--start and setup

function gamestart()
 generatefield()
 
 --testing
 
 cursor(4,1)
 color(8)
 for k,v in pairs(bombs) do
  --print(k)
 end
 
end

function generatefield()
 --set bomb locations
 for i=1,bombcount do
  local bx,by=getrandpoint(xfield,yfield)
  bombs[getfkey(bx,by)]=-1
 end
 --setup field
 --add bombs and intial values
 for fx=1,xfield do
  for fy=1,yfield do
   field[getfkey(fx,fy)] = {
    x=fx,
    y=fy,
    val=bombs[getfkey(fx,fy)] or 0,
    iscovered=true,
    isflagged=false,
   }
  
  end
 end
 --setup tile count vals
 for fx=1,xfield do
  for fy=1,yfield do
   setbombcnt(fx,fy)
  end
 end
 --set field tiles
 --xoff,yoff start pos offset
 local xoff,yoff=
   flr((maxgamex-xfield)/2),
   flr((maxgamey-yfield)/2)
 for fx=1,xfield do
  for fy=1,yfield do
   local fval=field[getfkey(fx,fy)].val
   mset((fx+xoff),
        (fy+yoff),
        fieldtls[fval+2])
  end
 end
 
end

-->8
--updates
-->8
--drawing

function drawgame()
 cls()
 map()
 --draw field sprites
 --draw player
end

function drawspr(_sprts,
         _x,_y,spd,trnsp)
 trnsp=trnsp or false
 palt(0,trnsp)
 spr(getframe(_sprts,spd),_x,_y)
end

function getframe(ani,spd)
 return ani[flr(t/spd)%#ani+1]
end

-->8
--utils

function getfkey(x,y)
 return x..","..y
end

--calc and ret random point
function getrandpoint(maxx,maxy)
 return flr(rnd(maxx))+1,
        flr(rnd(maxy))+1
end

--set bomb count around point
function setbombcnt(_x,_y)
 local fieldpt=field[getfkey(_x,_y)]
 --if on bomb, skip
 if fieldpt.val==-1 then return end
 local count=0
 for pt in all(aroundpt) do
  local ax,ay=max(min(_x+pt.x,xfield),1),
              max(min(_y+pt.y,yfield),1)
  local ptval=field[getfkey(ax,ay)]
  if ptval.val==-1 then
   count+=1
  end
  fieldpt.val=count
 end 
end
-->8
--data

function loaddata()
 --for finding items around a point
 aroundpt={
  {x=-1,y=-1},
  {x= 0,y=-1},
  {x= 1,y=-1},
  {x=-1,y= 0},
  {x= 1,y= 0},
  {x=-1,y= 1},
  {x= 0,y= 1},
  {x= 1,y= 1}, 
 }
end

function loadanisets()
 fieldtls={16,17,18,19,20,
           21,22,23,24,25}
 bomb=16
end
__gfx__
00000000770000770007700066000066000660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000700000070000000060000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000007000000700000000600000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000007000000700000000600000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000700000070000000060000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000770000770007700066000066000660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666666666666666666666666666666666666666666666666666666666666666666666000000000000000000000000000000000000000000000000
618888156666666566aa66656699966566888665668686656688866566eee66566eee66566333665000000000000000000000000000000000000000000000000
6889988566666665666a66656666966566668665668686656686666566e666656666e66566363665000000000000000000000000000000000000000000000000
689aa98566666665666a66656699966566688665668886656688866566eee6656666e66566333665000000000000000000000000000000000000000000000000
689aa98566666665666a66656696666566668665666686656666866566e6e6656666e66566363665000000000000000000000000000000000000000000000000
688998856666666566aaa6656699966566888665666686656688866566eee6656666e66566333665000000000000000000000000000000000000000000000000
61888815666666656666666566666665666666656666666566666665666666656666666566666665000000000000000000000000000000000000000000000000
65555555655555556555555565555555655555556555555565555555655555556555555565555555000000000000000000000000000000000000000000000000
66666666000000000000000000000000000000000000000000000000000000000000000066666666000000000000000000000000000000000000000000000000
66666665000000000000000000000000000000000000000000000000000000000000000061888815000000000000000000000000000000000000000000000000
66666665000000000000000000000000000000000000000000000000000000000000000068899885000000000000000000000000000000000000000000000000
666666650000000000000000000000000000000000000000000000000000000000000000689aa985000000000000000000000000000000000000000000000000
666666650000000000000000000000000000000000000000000000000000000000000000689aa985000000000000000000000000000000000000000000000000
66666665000000000000000000000000000000000000000000000000000000000000000068899885000000000000000000000000000000000000000000000000
66666665000000000000000000000000000000000000000000000000000000000000000061888815000000000000000000000000000000000000000000000000
65555555000000000000000000000000000000000000000000000000000000000000000065555555000000000000000000000000000000000000000000000000
__map__
2000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
