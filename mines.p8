pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
--mines
--brettski

function _init()
 t=0
 
 maxgamex=14
 maxgamey=14
 xfield=10   --field x max
 yfield=10   --field y max
 bombcount=10
 bombs={} --bomb locations
 field={}    --playing field
 tocover={}  --tiles to cover

 loaddata()
 loadanisets()
 gamestart()
 _upd=updategame
 _drw=drawgame
end

function _update()
 t+=1
 
 _upd()
end

function _draw()

	_drw()
end


-->8
--start and setup

function gamestart()
 plr_x=7
 plr_y=7
 plr_ox=0
 plr_oy=0
 plr_sox=0
 plr_soy=0
 plr_mov=nil
 plr_t=0
 
 generatefield()
  
end

function generatefield()
 --set bomb locations
 for i=1,bombcount do
  local bx,by=getrandpoint(xfield,yfield)
  bombs[getfkey(bx,by)]=-1
 end
 --setup field
 --add bombs and intial values
 --xoff,yoff start pos offset
 local xoff,yoff=
   flr((maxgamex-xfield)/2),
   flr((maxgamey-yfield)/2)
 for fx=1,xfield do
  for fy=1,yfield do
   field[getfkey(fx,fy)] = {
    x=fx,
    y=fy,
    tx=fx+xoff,
    ty=fy+yoff,
    val=bombs[getfkey(fx,fy)] or 0,
    iscovered=true,
    isflagged=false,
   }
  
  end
 end
 --setup tile count vals
 for fx=1,xfield do
  for fy=1,yfield do
   setbombcnt(fx,fy)
  end
 end
 --set field tiles
 for fx=1,xfield do
  for fy=1,yfield do
   local ft=field[getfkey(fx,fy)]
   mset((ft.tx),
        (ft.ty),
        fieldtls[ft.val+2])
  end
 end
 
end

-->8
--updates

function updategame()
 dobutton(getbutton())
end

function getbutton()
 for i=0,5 do
  if btnp(i) then
   return i
  end
 end
 return -1
end

function dobutton(butt)
 if butt<0 then return end
 if butt<4 then
  --⬅️➡️⬆️⬇️
  moveplr(dirx[butt+1],diry[butt+1])
 elseif butt==4 then
  --🅾️
 elseif butt==5 then
  --❎
 end
end

function updfcover()

end
-->8
--drawing

function drawgame()
 cls()
 map()
 --draw field sprites
 drawfcover()
 --draw player
 drawplr()
end

function drawspr(_sprts,
         _x,_y,spd,trnsp)
 trnsp=trnsp or false
 palt(0,trnsp)
 spr(getframe(_sprts,spd),_x,_y)
end

function getframe(ani,spd)
 return ani[flr(t/spd)%#ani+1]
end

function drawplr()
 drawspr(plr_ani,
  plr_x*8,plr_y*8,8,true)
end

function drawfcover()
 for ct in all(tocover) do
  --
 end
end
-->8
--utils

function getfkey(x,y)
 return x..","..y
end

--calc and ret random point
function getrandpoint(maxx,maxy)
 return flr(rnd(maxx))+1,
        flr(rnd(maxy))+1
end

--set bomb count around point
function setbombcnt(_x,_y)
 local fieldpt=field[getfkey(_x,_y)]
 --if on bomb, skip
 if fieldpt.val==-1 then return end
 local count=0
 for pt in all(aroundpt) do
  local ax,ay=_x+pt.x,_y+pt.y
  
  if ax<1 or ay<1 or
     ax>xfield or ay>yfield then
  	--do nothing
  else
   local ptval=field[getfkey(ax,ay)]
   if ptval.val==-1 then
    count+=1
   end
   fieldpt.val=count
  end
 end 
end
-->8
--gameplay

function moveplr(_x,_y)
 plr_x+=_x
 plr_y+=_y
end

--do flag tile
function doflag(_x,_y)

end

--do select tile
function doselect(_x,_y)

end
-->8
--data

function loaddata()
 --for finding items around a point
 aroundpt={
  {x=-1,y=-1},
  {x= 0,y=-1},
  {x= 1,y=-1},
  {x=-1,y= 0},
  {x= 1,y= 0},
  {x=-1,y= 1},
  {x= 0,y= 1},
  {x= 1,y= 1}, 
 }
 dirx={-1,1,0,0}
 diry={0,0,-1,1}
end

function loadanisets()
 fieldtls={16,17,18,19,20,
           21,22,23,24,25}
 plr_ani={1,2,3,4}
end
__gfx__
00000000770000770777000000077000000007700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000700000070000000700077000770007700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000700000000770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000777000077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000007000000077000077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000007000000000000000000000770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000700000077000000000077000077000770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000770000770000777000077000077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666666666666666666666666666666666666666666666666666666666666666666666666666000000000000000000000000000000000000000000000000
618888156666666566aa66656699966566888665668686656688866566eee66566eee66566333665000000000000000000000000000000000000000000000000
6889988566666665666a66656666966566668665668686656686666566e666656666e66566363665000000000000000000000000000000000000000000000000
689aa98566666665666a66656699966566688665668886656688866566eee6656666e66566333665000000000000000000000000000000000000000000000000
689aa98566666665666a66656696666566668665666686656666866566e6e6656666e66566363665000000000000000000000000000000000000000000000000
688998856666666566aaa6656699966566888665666686656688866566eee6656666e66566333665000000000000000000000000000000000000000000000000
61888815666666656666666566666665666666656666666566666665666666656666666566666665000000000000000000000000000000000000000000000000
65555555655555556555555565555555655555556555555565555555655555556555555565555555000000000000000000000000000000000000000000000000
66666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6a666665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
65555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
2000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
